<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>羽球報名系統</title>
  </head>
  <body>
    <h2>報名表單</h2>
    <form id="bookingForm">
      <label>姓名：</label>
      <input type="text" id="name" required /><br /><br />

      <label>程度：</label>
      <select id="level">
        <option>新手</option>
        <option>初階</option>
        <option>歡樂</option></select
      ><br /><br />

      <label>場次：</label>
      <input
        type="text"
        id="session"
        placeholder="例如：4/5 南屯A場"
        required
      /><br /><br />

      <button type="submit">報名</button>
    </form>

    <h3>目前報名人員：</h3>
    <div id="registrationsList"></div>
    <p id="status"></p>

    <script>
      const scriptUrl =
        "https://script.google.com/macros/s/AKfycbzFWdO-XagKt9uiJwi6sQEDSeYBAYIF6iKf3Cv9AuY1KTaQnBzkKLRBNmjaQjKNK7O1Ww/exec";

      // 報名表單提交
      document
        .getElementById("bookingForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          document.getElementById("status").textContent = "處理中...";

          const name = document.getElementById("name").value;
          const level = document.getElementById("level").value;
          const session = document.getElementById("session").value;

          fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify({ name, level, session }),
            headers: {
              "Content-Type": "text/plain", // 注意這裡用 text/plain 而非 application/json
            },
          })
            .then((res) => res.json()) // 改為 .json()
            .then((data) => {
              if (data.status === "success") {
                document.getElementById("status").textContent =
                  "✅ " + data.message;
                document.getElementById("bookingForm").reset();
                // 重新載入報名名單
                fetchRegistrations();
              } else {
                document.getElementById("status").textContent =
                  "❌ " + data.message;
              }
            })
            .catch((err) => {
              console.error("錯誤:", err);
              document.getElementById("status").textContent =
                "❌ 發生錯誤，請稍後再試";
            });
        });

      // 獲取報名名單
      function fetchRegistrations() {
        fetch(scriptUrl)
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              const registrationsDiv =
                document.getElementById("registrationsList");
              registrationsDiv.innerHTML = "";

              if (data.data && data.data.length > 0) {
                const list = document.createElement("ul");

                data.data.forEach((reg) => {
                  const item = document.createElement("li");
                  // 格式化日期
                  const date = new Date(reg.date);
                  const formattedDate = date.toLocaleDateString();

                  item.textContent = `${reg.name} (${reg.level}) - ${reg.session} [${formattedDate}]`;
                  list.appendChild(item);
                });

                registrationsDiv.appendChild(list);
              } else {
                registrationsDiv.textContent = "目前沒有報名資料";
              }
            } else {
              document.getElementById("registrationsList").textContent =
                "無法載入報名資料";
            }
          })
          .catch((err) => {
            console.error("載入報名資料錯誤:", err);
            document.getElementById("registrationsList").textContent =
              "載入報名資料時發生錯誤";
          });
      }

      // 頁面載入時獲取報名名單
      document.addEventListener("DOMContentLoaded", fetchRegistrations);
    </script>
  </body>
</html>
